<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>C++ implementation of Matrix's nearPD — nmNearPD • nlmixr2est</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="C++ implementation of Matrix's nearPD — nmNearPD"><meta name="description" content="With `ensureSymmetry` it makes sure it is symmetric by applying 0.5*(t(x) + x) before using nmNearPD"><meta property="og:description" content="With `ensureSymmetry` it makes sure it is symmetric by applying 0.5*(t(x) + x) before using nmNearPD"><meta property="og:image" content="https://nlmixr2.github.io/nlmixr2est/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nlmixr2est</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nlmixr2/nlmixr2est/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>C++ implementation of Matrix's nearPD</h1>
      <small class="dont-index">Source: <a href="https://github.com/nlmixr2/nlmixr2est/blob/main/R/utils.R" class="external-link"><code>R/utils.R</code></a></small>
      <div class="d-none name"><code>nmNearPD.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>With `ensureSymmetry` it makes sure it is symmetric by applying 0.5*(t(x) + x) before using nmNearPD</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">nmNearPD</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  keepDiag <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  do2eigen <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  doDykstra <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  only.values <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  ensureSymmetry <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/isSymmetric.html" class="external-link">isSymmetric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  eig.tol <span class="op">=</span> <span class="fl">1e-06</span>,</span>
<span>  conv.tol <span class="op">=</span> <span class="fl">1e-07</span>,</span>
<span>  posd.tol <span class="op">=</span> <span class="fl">1e-08</span>,</span>
<span>  maxit <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  trace <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>numeric \(n \times n\) approximately positive
    definite matrix, typically an approximation to a correlation or
    covariance matrix.  If <code>x</code> is not symmetric (and
    <code>ensureSymmetry</code> is not false), <code><a href="https://rdrr.io/pkg/Matrix/man/symmpart-methods.html" class="external-link">symmpart</a>(x)</code> is used.</p></dd>


<dt id="arg-keepdiag">keepDiag<a class="anchor" aria-label="anchor" href="#arg-keepdiag"></a></dt>
<dd><p>logical, generalizing <code>corr</code>: if <code>TRUE</code>, the
    resulting matrix should have the same diagonal
    (<code><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a>(x)</code>) as the input matrix.</p></dd>


<dt id="arg-do-eigen">do2eigen<a class="anchor" aria-label="anchor" href="#arg-do-eigen"></a></dt>
<dd><p>logical indicating if a
    <code><a href="https://rdrr.io/pkg/sfsmisc/man/posdefify.html" class="external-link">posdefify</a>()</code> eigen step should be applied to
    the result of the Higham algorithm.</p></dd>


<dt id="arg-dodykstra">doDykstra<a class="anchor" aria-label="anchor" href="#arg-dodykstra"></a></dt>
<dd><p>logical indicating if Dykstra's correction should be
    used; true by default.  If false, the algorithm is basically the
    direct fixpoint iteration
    \(Y_k = P_U(P_S(Y_{k-1}))\).</p></dd>


<dt id="arg-only-values">only.values<a class="anchor" aria-label="anchor" href="#arg-only-values"></a></dt>
<dd><p>logical; if <code>TRUE</code>, the result is just the
    vector of eigenvalues of the approximating matrix.</p></dd>


<dt id="arg-ensuresymmetry">ensureSymmetry<a class="anchor" aria-label="anchor" href="#arg-ensuresymmetry"></a></dt>
<dd><p>logical; by default, <code><a href="https://rdrr.io/pkg/Matrix/man/symmpart-methods.html" class="external-link">symmpart</a>(x)</code>
is used whenever <code>isSymmetric(x)</code> is not true.  The user
can explicitly set this to <code>TRUE</code> or <code>FALSE</code>, saving the
symmetry test. <em>Beware</em> however that setting it <code>FALSE</code>
for an <b>a</b>symmetric input <code>x</code>, is typically nonsense!</p></dd>


<dt id="arg-eig-tol">eig.tol<a class="anchor" aria-label="anchor" href="#arg-eig-tol"></a></dt>
<dd><p>defines relative positiveness of eigenvalues compared
    to largest one, \(\lambda_1\). Eigenvalues \(\lambda_k\) are
    treated as if zero when \(\lambda_k / \lambda_1 \le eig.tol\).</p></dd>


<dt id="arg-conv-tol">conv.tol<a class="anchor" aria-label="anchor" href="#arg-conv-tol"></a></dt>
<dd><p>convergence tolerance for Higham algorithm.</p></dd>


<dt id="arg-posd-tol">posd.tol<a class="anchor" aria-label="anchor" href="#arg-posd-tol"></a></dt>
<dd><p>tolerance for enforcing positive definiteness (in the
    final <code>posdefify</code> step when <code>do2eigen</code> is <code>TRUE</code>).</p></dd>


<dt id="arg-maxit">maxit<a class="anchor" aria-label="anchor" href="#arg-maxit"></a></dt>
<dd><p>maximum number of iterations allowed.</p></dd>


<dt id="arg-trace">trace<a class="anchor" aria-label="anchor" href="#arg-trace"></a></dt>
<dd><p>logical or integer specifying if convergence monitoring
    should be traced.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>unlike the matrix package, this simply returns the nearest
  positive definite matrix</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This implements the algorithm of Higham (2002), and then (if
  <code>do2eigen</code> is true) forces positive definiteness using code from
  <code><a href="https://rdrr.io/pkg/sfsmisc/man/posdefify.html" class="external-link">posdefify</a></code>.  The algorithm of Knol and ten
  Berge (1989) (not implemented here) is more general in that it
  allows constraints to (1) fix some rows (and columns) of the matrix and
  (2) force the smallest eigenvalue to have a certain value.</p>
<p>Note that setting <code>corr = TRUE</code> just sets <code>diag(.) &lt;- 1</code>
  within the algorithm.</p>
<p>Higham (2002) uses Dykstra's correction, but the version by Jens
  Oehlschlägel did not use it (accidentally),
  and still gave reasonable results; this simplification, now only
  used if <code>doDykstra = FALSE</code>,
  was active in <code>nearPD()</code> up to Matrix version 0.999375-40.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p><!-- %% more in /u/maechler/R/Pkgs/sfsmisc/man/posdefify.Rd -->
  Cheng, Sheung Hun and Higham, Nick (1998)
  A Modified Cholesky Algorithm Based on a Symmetric Indefinite Factorization;
  <em>SIAM J. Matrix Anal.\ Appl.</em>, <b>19</b>, 1097–1110.</p>
<p>Knol DL, ten Berge JMF (1989)
  Least-squares approximation of an improper correlation matrix by a
  proper one.
  <em>Psychometrika</em> <b>54</b>, 53–61.</p>
<p>Higham, Nick (2002)
  Computing the nearest correlation matrix - a problem from finance;
  <em>IMA Journal of Numerical Analysis</em> <b>22</b>, 329–343.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>A first version of this (with non-optional <code>corr=TRUE</code>)
  has been available as <code><a href="https://rdrr.io/pkg/sfsmisc/man/nearcor.html" class="external-link">nearcor</a>()</code>; and
  more simple versions with a similar purpose
  <code><a href="https://rdrr.io/pkg/sfsmisc/man/posdefify.html" class="external-link">posdefify</a>()</code>, both from package <span class="pkg">sfsmisc</span>.</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Jens Oehlschlägel donated a first version.
  Subsequent changes by the Matrix package authors.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="va">m</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       [,1]  [,2]  [,3]  [,4]  [,5]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]  1.00  0.65 -0.46 -1.15 -0.76</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]  0.65  1.00  0.58  0.50 -0.90</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] -0.46  0.58  1.00 -0.45 -0.32</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,] -1.15  0.50 -0.45  1.00  0.25</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5,] -0.76 -0.90 -0.32  0.25  1.00</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">near.m</span> <span class="op">&lt;-</span> <span class="fu">nmNearPD</span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">near.m</span>, <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       [,1]  [,2]  [,3]  [,4]  [,5]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]  1.31  0.41 -0.24 -0.85 -0.75</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]  0.41  1.19  0.41  0.27 -0.91</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] -0.24  0.41  1.15 -0.24 -0.32</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,] -0.85  0.27 -0.24  1.28  0.26</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5,] -0.75 -0.91 -0.32  0.26  1.00</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">m</span> <span class="op">-</span> <span class="va">near.m</span><span class="op">)</span> <span class="co"># 1.102 / 1.08</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 1.079735</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu">nmNearPD</span><span class="op">(</span><span class="va">m</span>, only.values<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">9</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             [,1] [,2] [,3] [,4] [,5]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 2.800681404    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] 1.831722441    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,] 1.229003616    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,] 0.076994641    0    0    0    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5,] 0.000000028    0    0    0    0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## A longer example, extended from Jens' original,</span></span></span>
<span class="r-in"><span><span class="co">## showing the effects of some of the options:</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,     <span class="fl">0.477</span>, <span class="fl">0.644</span>, <span class="fl">0.478</span>, <span class="fl">0.651</span>, <span class="fl">0.826</span>,</span></span>
<span class="r-in"><span>               <span class="fl">0.477</span>, <span class="fl">1</span>,     <span class="fl">0.516</span>, <span class="fl">0.233</span>, <span class="fl">0.682</span>, <span class="fl">0.75</span>,</span></span>
<span class="r-in"><span>               <span class="fl">0.644</span>, <span class="fl">0.516</span>, <span class="fl">1</span>,     <span class="fl">0.599</span>, <span class="fl">0.581</span>, <span class="fl">0.742</span>,</span></span>
<span class="r-in"><span>               <span class="fl">0.478</span>, <span class="fl">0.233</span>, <span class="fl">0.599</span>, <span class="fl">1</span>,     <span class="fl">0.741</span>, <span class="fl">0.8</span>,</span></span>
<span class="r-in"><span>               <span class="fl">0.651</span>, <span class="fl">0.682</span>, <span class="fl">0.581</span>, <span class="fl">0.741</span>, <span class="fl">1</span>,     <span class="fl">0.798</span>,</span></span>
<span class="r-in"><span>               <span class="fl">0.826</span>, <span class="fl">0.75</span>,  <span class="fl">0.742</span>, <span class="fl">0.8</span>,   <span class="fl">0.798</span>, <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>               nrow <span class="op">=</span> <span class="fl">6</span>, ncol <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">nc</span>  <span class="op">&lt;-</span> <span class="fu">nmNearPD</span><span class="op">(</span><span class="va">pr</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Fidler, Yuan Xiong, Rik Schoemaker, Justin Wilkins, Wenping Wang, Vipul Mann, Richard Hooijmaijers.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

